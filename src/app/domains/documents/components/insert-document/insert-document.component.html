<!-- insert-document.component.html -->
<app-tool-bar *ngIf="modal === 0" [title]="title" [isProfessional]="isProfessional" [isCorporative]="isCorporative">
</app-tool-bar>

<div class="container-fluid main page-content" [class.modal-mode]="modal === 1">
  <!-- Layout Principal: Formulário Alargado -->
  <div class="row main-content">
    <div class="col-12 form-column">
      <div class="card form-card">
        <div class="card-body form-body">
          <!-- Message area -->
          <div *ngIf="submitMessage" class="alert message-sm"
            [ngClass]="submitSuccess ? 'alert-success' : 'alert-danger'" role="alert">
            <span class="material-icons me-1" style="font-size: 16px;">
              {{ submitSuccess ? 'check_circle' : 'error' }}
            </span>
            {{ submitMessage }}
          </div>

          <form (ngSubmit)="onSubmit()" #documentForm="ngForm">
            <!-- Process information panel (shown when process is provided) -->
            <div *ngIf="existingProcess" class="info-panel-expanded">
              <div class="info-icon">
                <span class="material-icons">folder_open</span>
              </div>
              <div class="info-content">
                <strong>Adicionando documento ao processo:</strong> {{ existingProcess }}<br>
                <small>O identificador único será gerado automaticamente com base no tipo do documento</small>
              </div>
            </div>

            <!-- Informações Básicas -->
            <!-- Informações Básicas -->
            <div class="form-section-expanded">
              <h6 class="section-title">Informações Básicas</h6>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="nome" class="form-label-expanded">Nome do Documento <span
                      class="required">*</span></label>
                  <input type="text" id="nome" class="form-control form-control-expanded" [(ngModel)]="formData.nome"
                    name="nome" placeholder="Ex: Ata da Reunião Plenária" required>
                </div>
                <div class="col-md-3 mb-3">
                  <label for="dataDocumento" class="form-label-expanded">Data <span class="required">*</span></label>
                  <input type="date" id="dataDocumento" class="form-control form-control-expanded"
                    [(ngModel)]="formData.dataDocumento" name="dataDocumento" required>
                </div>
                <div class="col-md-3 mb-3">
                  <label for="tipoDocumento" class="form-label-expanded">Tipo <span class="required">*</span></label>
                  <select id="tipoDocumento" class="form-control form-control-expanded"
                    [(ngModel)]="formData.tipoDocumentoId" name="tipoDocumento" required>
                    <option value="0" disabled>Selecione...</option>
                    <option *ngFor="let tipo of tiposDocumento" [value]="tipo.id">
                      {{ tipo.name }}
                    </option>
                  </select>
                </div>
              </div>

              <div class="row">
                <div class="col-md-12 mb-3">
                  <label for="assunto" class="form-label-expanded">Descrição</label>
                  <input type="text" id="assunto" class="form-control form-control-expanded"
                    [(ngModel)]="formData.assunto" name="assunto" placeholder="Descreva brevemente o documento">
                </div>
              </div>
            </div>

            <!-- Numeração do Processo -->
            <div class="form-section-expanded" *ngIf="!existingProcess">
              <h6 class="section-title">Numeração do Processo</h6>
              
              <div class="row">
                <div class="col-md-12 mb-3">
                  <label class="form-label-expanded">Como será gerado o número do processo?</label>
                  <div class="form-check-container-expanded">
                    <div class="form-check">
                      <input class="form-check-input" 
                             type="radio" 
                             id="protocolAuto" 
                             name="protocolType" 
                             value="false"
                             [(ngModel)]="formData.useManualProtocol">
                      <label class="form-check-label" for="protocolAuto">
                        <span class="material-icons me-1" style="font-size: 16px; vertical-align: middle;">auto_mode</span>
                        Gerar automaticamente
                      </label>
                      <small class="form-text text-muted d-block">O sistema gerará o prefixo + número sequencial baseado no tipo do documento</small>
                    </div>
                    <div class="form-check mt-2">
                      <input class="form-check-input" 
                             type="radio" 
                             id="protocolManual" 
                             name="protocolType" 
                             value="true"
                             [(ngModel)]="formData.useManualProtocol">
                      <label class="form-check-label" for="protocolManual">
                        <span class="material-icons me-1" style="font-size: 16px; vertical-align: middle;">edit</span>
                        Informar número manual
                      </label>
                      <small class="form-text text-muted d-block">Para receituários agronômicos ou documentos com numeração específica</small>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Campo para número manual (aparece condicionalmente) -->
              <div class="row" *ngIf="formData.useManualProtocol === 'true'">
                <div class="col-md-6 mb-3">
                  <label for="manualProtocolNumber" class="form-label-expanded">Número Específico <span class="required">*</span></label>
                  <input type="text" 
                         id="manualProtocolNumber" 
                         class="form-control form-control-expanded" 
                         [(ngModel)]="formData.manualProtocolNumber"
                         name="manualProtocolNumber"
                         placeholder="Ex: 2025-001234"
                         [required]="formData.useManualProtocol === 'true'">
                  <small class="form-text text-muted">
                    Digite apenas o número. O prefixo será adicionado automaticamente baseado no tipo do documento.
                  </small>
                </div>
              </div>
            </div>

            <!-- Pessoas Envolvidas -->
            <!-- <div class="form-section-expanded">
              <h6 class="section-title">Pessoas Envolvidas</h6>
              
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label for="interessado" class="form-label-expanded">Interessado</label>
                  <input type="text" 
                         id="interessado" 
                         class="form-control form-control-expanded" 
                         [(ngModel)]="formData.interessadoNome"
                         name="interessado"
                         placeholder="Nome do interessado">
                </div>
                <div class="col-md-4 mb-3">
                  <label for="remetente" class="form-label-expanded">Remetente</label>
                  <input type="text" 
                         id="remetente" 
                         class="form-control form-control-expanded" 
                         [(ngModel)]="formData.remetenteNome"
                         name="remetente"
                         placeholder="Nome do remetente">
                </div>
                <div class="col-md-4 mb-3">
                  <label for="destinatario" class="form-label-expanded">Destinatário</label>
                  <input type="text" 
                         id="destinatario" 
                         class="form-control form-control-expanded" 
                         [(ngModel)]="formData.destinatarioNome"
                         name="destinatario"
                         placeholder="Nome do destinatário">
                </div>
              </div>
            </div> -->

            <!-- Origem e Detalhes -->
            <!-- Origem e Detalhes -->
            <div class="form-section-expanded">
              <h6 class="section-title">Origem e Detalhes</h6>

              <div class="row">
                <!-- <div class="col-md-4 mb-3">
                  <label for="orgaoOrigem" class="form-label-expanded">Órgão</label>
                  <select id="orgaoOrigem" 
                          class="form-control form-control-expanded"
                          [(ngModel)]="formData.orgaoOrigem"
                          name="orgaoOrigem">
                    <option value="">Selecione...</option>
                    <option *ngFor="let orgao of orgaosOrigem" [value]="orgao">
                      {{ orgao }}
                    </option>
                  </select>
                </div> -->
            
                <div class="col-md-4 mb-3">
                  <label for="palavrasChave" class="form-label-expanded">Palavras-chave</label>
                  <input type="text" id="palavrasChave" class="form-control form-control-expanded"
                    [(ngModel)]="formData.palavrasChave" name="palavrasChave"
                    placeholder="reunião, plenária, deliberação">
                </div>
              </div>

              <div class="row">
                <div class="col-md-8 mb-3">
                  <label for="observacoes" class="form-label-expanded">Observações</label>
                  <textarea id="observacoes" class="form-control form-control-expanded" rows="1"
                    [(ngModel)]="formData.observacoes" name="observacoes"
                    placeholder="Observações adicionais sobre o documento..."></textarea>
                </div>
                
              </div>
            </div>

            <!-- 🔐 Controle de Acesso -->
            <div class="form-section-expanded">
              <h6 class="section-title">
                <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">security</span>
                Controle de Acesso
              </h6>

              <div class="row">
                <!-- Setor Responsável -->
                <div class="col-md-6 mb-3">
                  <label for="setor" class="form-label-expanded">
                    <span class="material-icons" style="font-size: 16px; vertical-align: middle;">business</span>
                    Setor Responsável
                  </label>
                  <select id="setor"
                          class="form-control form-control-expanded"
                          [(ngModel)]="formData.setorId"
                          name="setor">
                    <option [value]="undefined">Nenhum setor específico</option>
                    <option *ngFor="let setor of setores" [value]="setor.id">
                      {{ setor.name }} ({{ setor.acronym }})
                    </option>
                  </select>
                  <small class="form-text text-muted">
                    O setor responsável terá acesso automático ao documento
                  </small>
                </div>
              </div>

              <!-- Informação sobre permissões avançadas -->
              <div class="row">
                <div class="col-12">
                  <div class="alert alert-info" style="font-size: 13px; padding: 10px;">
                    <span class="material-icons me-2" style="vertical-align: middle; font-size: 18px;">info</span>
                    <strong>Dica:</strong> Após criar o documento, você poderá gerenciar permissões detalhadas (visualizar, editar, assinar, baixar) através do botão de segurança no visualizador.
                  </div>
                </div>
              </div>
            </div>

            <!-- 📋 Classificação de Acesso SEI -->
            <div class="form-section-expanded">
              <h6 class="section-title">
                <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">gavel</span>
                Classificação de Acesso (Lei 12.527/2011)
              </h6>

              <div class="row">
                <!-- Nível de Acesso -->
                <div class="col-md-6 mb-3">
                  <label for="nivelAcesso" class="form-label-expanded">
                    Nível de Acesso <span class="required">*</span>
                  </label>
                  <select id="nivelAcesso"
                          class="form-control form-control-expanded"
                          [(ngModel)]="formData.nivelAcesso"
                          name="nivelAcesso"
                          required>
                    <option value="Publico">🌍 Público (Sem restrições)</option>
                    <option value="Restrito">🔒 Restrito (Requer permissão específica)</option>
                    <option value="Sigiloso">🔐 Sigiloso (Alto grau de sigilo)</option>
                  </select>
                  <small class="form-text text-muted">
                    Baseado na Lei de Acesso à Informação (LAI)
                  </small>
                </div>

                <!-- Nível de Restrição (Condicional) -->
                <div class="col-md-6 mb-3" *ngIf="isDocumentoRestrito">
                  <label for="nivelRestricao" class="form-label-expanded">
                    Nível de Restrição <span class="required">*</span>
                  </label>
                  <select id="nivelRestricao"
                          class="form-control form-control-expanded"
                          [(ngModel)]="formData.nivelRestricao"
                          name="nivelRestricao"
                          [required]="isDocumentoRestrito">
                    <option [value]="undefined">Selecione...</option>
                    <option value="Usuario">👤 Usuário (Restrição Pessoal)</option>
                    <option value="Unidade">🏢 Unidade (Restrição Setorial)</option>
                  </select>
                  <small class="form-text text-muted">
                    Como as permissões serão gerenciadas
                  </small>
                </div>
              </div>

              <!-- Hipótese Legal (Condicional) -->
              <div class="row" *ngIf="isDocumentoRestrito">
                <div class="col-12 mb-3">
                  <label for="hipoteseLegal" class="form-label-expanded">
                    <span class="material-icons" style="font-size: 16px; vertical-align: middle;">balance</span>
                    Hipótese Legal de Restrição <span class="required">*</span>
                  </label>
                  <textarea id="hipoteseLegal"
                            class="form-control form-control-expanded"
                            [(ngModel)]="formData.hipoteseLegal"
                            name="hipoteseLegal"
                            rows="3"
                            [required]="isDocumentoRestrito"
                            placeholder="Ex: Lei 12.527/2011, Art. 23, I - Informações pessoais protegidas"></textarea>
                  <small class="form-text text-muted">
                    ⚠️ <strong>Obrigatório:</strong> Toda restrição de acesso deve ser fundamentada em base legal
                  </small>
                </div>
              </div>

              <!-- Exemplos de Hipóteses Legais -->
              <div class="row" *ngIf="formData.nivelAcesso !== 'Publico'">
                <div class="col-12">
                  <div class="alert alert-warning" style="font-size: 12px; padding: 10px;">
                    <strong>📚 Exemplos de hipóteses legais:</strong>
                    <ul class="mb-0 mt-2" style="padding-left: 20px;">
                      <li>Lei 12.527/2011, Art. 23, I - Informações pessoais</li>
                      <li>Lei 12.527/2011, Art. 23, II - Segredo de justiça</li>
                      <li>Lei 12.527/2011, Art. 23, III - Sigilo comercial ou empresarial</li>
                      <li>Lei 13.709/2018 (LGPD) - Dados pessoais sensíveis</li>
                      <li>Lei 8.159/1991, Art. 23 - Documentos sigilosos</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>

            <!-- Arquivo -->
            <div class="form-section-expanded">
              <h6 class="section-title">Arquivo <span class="required">*</span></h6>

              <div class="file-upload-area-expanded">
                <input type="file" id="arquivo" class="form-control form-control-expanded"
                  (change)="onFileSelected($event)" accept=".pdf,.doc,.docx,.mp3,.mp4" required>
                <small class="form-text text-muted">
                  Formatos aceitos: PDF, DOC, DOCX, MP3, MP4 • Tamanho máximo: 50MB
                </small>
                <div *ngIf="selectedFile" class="file-selected-expanded mt-2">
                  <span class="material-icons">check_circle</span>
                  <div class="file-info">
                    <strong>{{ selectedFile.name }}</strong><br>
                    <small>{{ (selectedFile.size / 1024 / 1024).toFixed(2) }} MB</small>
                  </div>
                </div>
              </div>
            </div>

            <!-- Botões -->
            <div class="form-actions-expanded">
              <button type="button" class="btn btn-secondary" (click)="onCancel()" [disabled]="isSubmitting">
                Cancelar
              </button>
              <button type="submit" class="btn btn-primary" [disabled]="isSubmitting || documentForm.invalid">
                <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2"></span>
                {{ isSubmitting ? 'Salvando Documento...' : 'Salvar Documento' }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Sucesso -->
<div class="success-overlay" *ngIf="showSuccessModal" (click)="showSuccessModal = false">
  <div class="success-modal" (click)="$event.stopPropagation()">
    <div class="success-content">
      <span class="material-icons success-icon">check_circle</span>
      <h4 class="success-title">Documento Inserido!</h4>
      <p class="success-message">{{ submitMessage }}</p>
      <div class="success-actions">
        <button class="btn btn-primary" (click)="showSuccessModal = false">
          <span class="material-icons me-1">done</span>
          OK
        </button>
      </div>
    </div>
  </div>
</div>