<!-- user-management.component.html -->
<app-tool-bar [title]="'Gerenciamento de Usuários'" [isProfessional]="false" [isCorporative]="true">
</app-tool-bar>

<div class="user-management-container">
  
  <!-- Cabeçalho -->
  <div class="management-header">
    <div class="header-content">
      <h4 class="management-title">
        <span class="material-icons">people</span>
        Gerenciamento de Usuários
      </h4>
      <button 
        type="button" 
        class="btn btn-primary create-user-btn"
        (click)="createUser()"
        [disabled]="isLoading">
        <span class="material-icons">person_add</span>
        Criar Usuário
      </button>
    </div>
  </div>

  <!-- Mensagens -->
  <div *ngIf="messages.errorMessage" class="alert alert-danger message-sm">
    <div [innerHTML]="messages.errorMessage"></div>
  </div>
  <div *ngIf="messages.alertMessage" class="alert alert-warning message-sm">
    <div [innerHTML]="messages.alertMessage"></div>
  </div>
  <div *ngIf="messages.successMessage" class="alert alert-success message-sm">
    <div [innerHTML]="messages.successMessage"></div>
  </div>

  <!-- Filtros e Busca -->
  <div class="filters-section">
    <div class="row">
      <div class="col-md-6">
        <div class="search-container">
          <label for="userSearch" class="form-label-expanded">Buscar Usuários:</label>
          <div class="search-input-container">
            <input 
              type="text" 
              class="form-control form-control-expanded search-input"
              id="userSearch"
              #searchInput
              (input)="onSearchChange(searchInput.value)"
              [value]="searchTerm"
              placeholder="Digite nome, email ou role..."
              [disabled]="isLoading">
            <button 
              type="button" 
              class="btn btn-clear-search"
              (click)="clearFilters(); searchInput.value = ''"
              *ngIf="searchTerm || selectedRole"
              [disabled]="isLoading"
              title="Limpar filtros">
              <span class="material-icons">clear</span>
            </button>
            <span class="search-icon material-icons">search</span>
          </div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="role-filter-container">
          <label for="roleFilter" class="form-label-expanded">Filtrar por Role:</label>
          <select 
            class="form-control form-control-expanded"
            id="roleFilter"
            (change)="onRoleFilterChange($any($event.target).value)"
            [value]="selectedRole"
            [disabled]="isLoading">
            <option value="">Todas as roles</option>
            <option [value]="role.id" *ngFor="let role of availableRoles">{{ role.name }}</option>
            <option value="custom">Permissões Específicas</option>
          </select>
        </div>
      </div>

      <div class="col-md-2">
        <div class="results-info">
          <span class="results-count">
            {{ getPaginationInfo() }}
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Lista de Usuários -->
  <div class="users-list-container">
    
    <!-- Estado de loading -->
    <div *ngIf="isLoading" class="loading-state">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Carregando...</span>
      </div>
      <span>Carregando usuários...</span>
    </div>

    <!-- Lista vazia -->
    <div *ngIf="!isLoading && totalUsers === 0" class="empty-state">
      <span class="material-icons">people_outline</span>
      <h6>{{ searchTerm || selectedRole ? 'Nenhum usuário encontrado' : 'Nenhum usuário cadastrado' }}</h6>
      <p class="text-muted">
        {{ searchTerm || selectedRole ? 
           'Tente ajustar os filtros de busca ou criar um novo usuário.' : 
           'Comece criando o primeiro usuário do sistema.' }}
      </p>
      <button 
        type="button" 
        class="btn btn-outline-primary"
        (click)="createUser()">
        <span class="material-icons">person_add</span>
        Criar Primeiro Usuário
      </button>
    </div>

    <!-- Lista de usuários -->
    <div *ngIf="!isLoading && totalUsers > 0" class="users-grid">
      
      <div *ngFor="let user of currentData; trackBy: trackByUserId" class="user-card">
        
        <!-- Status Badge -->
        <div class="user-status-badge" [class]="getStatusBadgeClass(user.isActive)">
          {{ getStatusText(user.isActive) }}
        </div>

        <!-- Informações do usuário -->
        <div class="user-info">
          <div class="user-avatar">
            <span class="material-icons">person</span>
          </div>
          
          <div class="user-details">
            <h6 class="user-name">{{ user.name }}</h6>
            <p class="user-email">{{ user.email }}</p>
            <div class="user-permissions">
              <span class="material-icons">security</span>
              <span>{{ getUserPermissionsText(user) }}</span>
            </div>
          </div>
        </div>

        <!-- Informações adicionais -->
        <div class="user-metadata">
          <div class="metadata-item">
            <span class="material-icons">schedule</span>
            <span class="metadata-label">Criado:</span>
            <span class="metadata-value">{{ formatDate(user.createdAt) }}</span>
          </div>
          <div class="metadata-item" *ngIf="user.lastLogin">
            <span class="material-icons">login</span>
            <span class="metadata-label">Último acesso:</span>
            <span class="metadata-value">{{ formatDate(user.lastLogin) }}</span>
          </div>
        </div>

        <!-- Ações -->
        <div class="user-actions">
          <button 
            type="button" 
            class="btn btn-outline-primary btn-sm"
            (click)="editUser(user)"
            [disabled]="isLoading"
            title="Editar usuário">
            <span class="material-icons">edit</span>
            Editar
          </button>
          
          <button 
            type="button" 
            class="btn btn-sm"
            [class]="user.isActive ? 'btn-outline-warning' : 'btn-outline-success'"
            (click)="toggleUserStatus(user)"
            [disabled]="isLoading"
            [title]="user.isActive ? 'Desativar usuário' : 'Ativar usuário'">
            <span class="material-icons">{{ user.isActive ? 'block' : 'check_circle' }}</span>
            {{ user.isActive ? 'Desativar' : 'Ativar' }}
          </button>
          
          <button 
            type="button" 
            class="btn btn-outline-danger btn-sm"
            (click)="deleteUser(user)"
            [disabled]="isLoading"
            title="Excluir usuário">
            <span class="material-icons">delete</span>
            Excluir
          </button>
        </div>

      </div>
    </div>

  </div>

  <!-- Controles de Paginação -->
  <div class="pagination-container" *ngIf="!isLoading && totalUsers > 0 && totalPages > 1">
    <div class="pagination-controls">
      
      <!-- Botão Anterior -->
      <button 
        type="button" 
        class="btn btn-outline-secondary btn-sm pagination-btn"
        (click)="previousPage()"
        [disabled]="!hasPreviousPage"
        title="Página anterior">
        <span class="material-icons">chevron_left</span>
        Anterior
      </button>

      <!-- Números das páginas -->
      <div class="page-numbers">
        <button 
          type="button"
          *ngFor="let page of getPageNumbers()"
          class="btn btn-sm page-number-btn"
          [class.active]="page === currentPage"
          [class.btn-primary]="page === currentPage"
          [class.btn-outline-secondary]="page !== currentPage"
          (click)="goToPage(page)"
          [title]="'Ir para página ' + page">
          {{ page }}
        </button>
      </div>

      <!-- Botão Próximo -->
      <button 
        type="button" 
        class="btn btn-outline-secondary btn-sm pagination-btn"
        (click)="nextPage()"
        [disabled]="!hasNextPage"
        title="Próxima página">
        Próximo
        <span class="material-icons">chevron_right</span>
      </button>

    </div>

    <!-- Informações da paginação -->
    <div class="pagination-info">
      <span class="pagination-text">
        Página {{ currentPage }} de {{ totalPages }} 
        <span class="text-muted">({{ totalUsers }} usuários no total)</span>
      </span>
    </div>
  </div>

  <!-- Informações de rodapé -->
  <div class="management-footer" *ngIf="!isLoading && totalUsers > 0">
    <div class="footer-stats">
      <div class="stat-item">
        <span class="material-icons">people</span>
        <span>{{ getActiveUsersCount() }} usuários ativos</span>
      </div>
      <div class="stat-item">
        <span class="material-icons">block</span>
        <span>{{ getInactiveUsersCount() }} usuários inativos</span>
      </div>
      <div class="stat-item">
        <span class="material-icons">admin_panel_settings</span>
        <span>{{ getAdminUsersCount() }} administradores</span>
      </div>
    </div>
  </div>

</div>